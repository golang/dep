language: go
sudo: false
notifications:
  email: false
jobs:
  include:
    - stage: test
      go_import_path: github.com/golang/dep
      install:
        - go get -u honnef.co/go/tools/cmd/{gosimple,staticcheck}
        - npm install -g codeclimate-test-reporter
      env:
        - DEPTESTBYPASS501=1
      os: linux
      go: 1.8.x
      script:
        - go build -v ./cmd/dep
        - PKGS=$(go list ./... | grep -v /vendor/)
        - go vet $PKGS
        - staticcheck $PKGS
        - gosimple $PKGS
        - ./hack/validate-vendor.bash
        - go build ./hack/licenseok
        - find . -path ./vendor -prune -o -type f -name "*.go" -printf '%P\n' | xargs ./licenseok
        - set -e; for pkg in $PKGS; do go test -race -coverprofile=profile.out -covermode=atomic $pkg; if [[ -f profile.out ]]; then cat profile.out >> coverage.txt; rm profile.out; fi; done
      after_success:
        - echo "CHANGE BACK THIS"
        # - codeclimate-test-reporter < coverage.txt
    # YAML alias, for settings shared across the simpler builds
    - &simple-test
      go: 1.7.x
      stage: test
      go_import_path: github.com/golang/dep
      install: skip
      env:
        - DEPTESTBYPASS501=1
      script: go test -race $(go list ./... | grep -v vendor)
    - <<: *simple-test
      go: tip
    - <<: *simple-test
      os: osx
      go: 1.8.x
      install:
        # brew takes horribly long to update itself despite the above caching
        # attempt; only bzr install if it's not on the $PATH
        - test $(which bzr) || brew install bzr
      env:
        - HOMEBREW_NO_AUTO_UPDATE=1
        - DEPTESTBYPASS501=1
      script:
        # OSX as of El Capitan sets an exit trap that interacts poorly with how
        # travis seems to spawn these shells; if set -e is set, then it can cause
        # build failures. We're not doing that here, but retain the trap statement
        # for future safety.
        # Related: https://superuser.com/questions/1044130/why-am-i-having-how-can-i-fix-this-error-shell-session-update-command-not-f
        - trap EXIT
        - go test -race $(go list ./... | grep -v vendor)
    - go: 1.8.x
      stage: deploy
      go_import_path: github.com/golang/dep
      install: skip
      script: skip
      before_deploy:
        - mkdir -p release
        - cd cmd/dep
        - CGO_ENABLED=0 GOOS=linux go build -ldflags "-s -w -X main.commitHash=$(git rev-parse --short HEAD 2>/dev/null) -X main.buildDate=$(date --iso-8601=seconds) -X main.version=$(git describe --tags --dirty)" -a -installsuffix cgo -o ../../release/dep-linux-amd64
        - CGO_ENABLED=0 GOOS=darwin go build -ldflags "-s -w -X main.commitHash=$(git rev-parse --short HEAD 2>/dev/null) -X main.buildDate=$(date --iso-8601=seconds) -X main.version=$(git describe --tags --dirty)" -a -installsuffix cgo -o ../../release/dep-darwin-amd64
        - CGO_ENABLED=0 GOOS=windows go build -ldflags "-s -w -X main.commitHash=$(git rev-parse --short HEAD 2>/dev/null) -X main.buildDate=$(date --iso-8601=seconds) -X main.version=$(git describe --tags --dirty)" -a -installsuffix cgo -o ../../release/dep-windows-amd64
        - cd ../..
      deploy:
        - provider: releases
          api_key:
            secure: IP1BqLO5WAkI/LFT/4WkiTS7g0zgliUt3y5zqJJKfXatnv4tD/mZIaaJsApjTcVpcI9zbTtZZKFcWPJG3JMVVSUQHSLwupyTk/2dCzUfFadZzRnOtkHysNWJjstYUsNkpr/Qh8Dnvf2HQ7vMA4F2mGMPOA/JT0u4UKJLWmiNdmV0pcqHUqszGnomoXP497bXpvGzn7AMG+QtKe/s5OIihaPoGCfr2UF+tldVPbOuykrlVH8u/Rxv2N8RePjKBNoLWnnMLp6Gg5VvSBJX0Ns7bPx1nQdOiSAY0sNuETe2SDSIoGhuSk9hGppPrCTxcql5SaRnxFigN1zr/XOstFMh9mAzjYG2H2MiRKvRaZFVT8pzvvhSLNKUYsW9G/dts63BJuUdFgV+sp0yeO5al9aR4h7g6QGUlnUJ4rtUE8rB2JINfTFSP1U00i6ihTwDLt7xspAWQ5DaCky3SLeLCuKc9Gj3moMDozW4a2iN/ooujYin3Lbbh65o6bWz71P+sjczb+igXKwOkwxscAwdR7IY3yWJ7hvx0KsDADvLtEeXG4IahL0C7Z2ZzHfAHaLiPvDNZ/CBOzYSjOQDx0c92kFfruts57kwgzNaNUAlzZtv5CdxWZDZ/n2HxOb1Bd74RxW4oyXrxcWS6trHzoPwTJ0RSbO8gfneU7xqBHhp7LXoG4E=
          file:
            - release/dep-linux-amd64
            - release/dep-darwin-amd64
          skip_cleanup: true
          on:
            repo: ebati/dep
            branch: ci-make-version
            tags: true
